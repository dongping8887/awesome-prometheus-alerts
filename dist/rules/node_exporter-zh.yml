# 服务器资源告警策略
groups:
  - name: 服务器资源监控
    rules:
      - alert: 内存使用率过高
        expr: 100- (node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_MemFree_bytes) / node_memory_MemTotal_bytes * 100 >= 90
        for: 5m  # 告警持续时间，超过这个时间才会发送给alertmanager
        labels:
          severity: 严重告警
        annotations:
          summary: "{{ $labels.instance }} 内存使用率过高，请尽快处理！"
          description: "{{ $labels.instance }}内存使用率超过90%,当前使用率{{ $value }}%."

      - alert: 服务器宕机
        expr: rate(node_time_seconds [3m]) == 0
        for: 3m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 服务器宕机，请尽快处理！"
          description: "{{$labels.instance}} 服务器延时超过3分钟，当前状态{{ $value }}. "

      - alert: CPU高负荷
        expr: 100 - (avg by (city, instance, job) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} CPU使用率过高，请尽快处理！"
          description: "{{$labels.instance}} CPU使用大于90%，当前使用率{{ $value }}%. "

      - alert: 系统高负荷
        expr: avg(node_load5) by (city, instance, job)/ count(count(node_cpu_seconds_total) by (city, instance, job, cpu)) by (city, instance, job) > 1
        for: 5m
        labels:
          severity: 告警
        annotations:
          summary: "{{$labels.instance}} 系统负载过高，请尽快处理！"
          description: "{{$labels.instance}} 系统负载单核平均值大于1，当前使用率{{ $value }}%. "

      - alert: 系统高负荷
        expr: avg(node_load5) by (city, instance, job)/ count(count(node_cpu_seconds_total) by (city, instance, job, cpu)) by (city, instance, job) > 2
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 系统负载过高，请尽快处理！"
          description: "{{$labels.instance}} 系统负载单核平均值大于2，当前使用率{{ $value }}%. "

      - alert: 磁盘IO性能
        expr: avg by(city, instance, job) (rate(node_disk_io_time_seconds_total[1m])) * 100 > 90
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 流入磁盘IO使用率过高，请尽快处理！"
          description: "{{$labels.instance}} 流入磁盘IO大于90%,当前使用率{{ $value }}%."


      - alert: 网络流入
        expr: (sum by(city, instance, job) (rate (node_network_receive_bytes_total{device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*',city!~"大同现场|淮南现场"}[5m]))) / 1024 / 1024 * 8 > 200
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 流入网络带宽过高，请尽快处理！"
          description: "{{$labels.instance}} 流入网络带宽持续5分钟高于200M. RX带宽使用量{{ $value }}."

      - alert: 网络流入-大同、淮南
        expr: (sum by(city, instance, job) (rate (node_network_receive_bytes_total{device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*',city=~"大同现场|淮南现场"}[5m]))) / 1024 / 1024 * 8 > 400
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 流入网络带宽过高，请尽快处理！"
          description: "{{$labels.instance}} 流入网络带宽持续5分钟高于200M. RX带宽使用量{{ $value }}."

      - alert: 网络流出
        expr: (sum by(city, instance, job) (rate (node_network_transmit_bytes_total{device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*', city !~"大同现场"}[5m])))  / 1024 / 1024 * 8 > 200
        for: 5m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.instance}} 流出网络带宽过高,请尽快处理！"
          description: "{{$labels.instance}} 流出网络带宽持续5分钟高于200M. RX带宽使用量{{ $value }}."

      - alert: TCP连接数
        expr: node_netstat_Tcp_CurrEstab > 10000
        for: 2m
        labels:
          severity: 严重告警
        annotations:
          summary: " TCP_ESTABLISHED过高！"
          description: "{{$labels.instance}} TCP_ESTABLISHED大于100%,当前使用率{{ $value }}%."

      - alert: 磁盘容量
        expr: 100 - ((node_filesystem_avail_bytes{device!~'rootfs'} * 100) / node_filesystem_size_bytes{device!~'rootfs'}) > 80
        for: 1m
        labels:
          severity: 告警
        annotations:
          summary: "{{$labels.mountpoint}} 磁盘分区使用率过高，请尽快处理！"
          description: "{{$labels.instance}} 磁盘分区使用大于80%，当前使用率{{ $value }}%."

      - alert: 磁盘容量
        expr: 100 - ((node_filesystem_avail_bytes{device!~'rootfs'} * 100) / node_filesystem_size_bytes{device!~'rootfs'}) > 90
        for: 1m
        labels:
          severity: 严重告警
        annotations:
          summary: "{{$labels.mountpoint}} 磁盘分区使用率过高，请尽快处理！"
          description: "{{$labels.instance}} 磁盘分区使用大于90%，当前使用率{{ $value }}%."
